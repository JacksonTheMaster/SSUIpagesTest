name: Deploy UI Preview to GitHub Pages

on:
  push:
    branches: [main]

permissions:
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up static folder
        run: |
          mkdir -p static
          cp UIMod/config.html static/
          cp UIMod/apiinfo.html static/
          cp UIMod/style.css static/
          cp UIMod/favicon.ico static/
          cp UIMod/stationeers.png static/

          cat <<EOF > static/script.js
          document.addEventListener("DOMContentLoaded",()=>{typeText(document.querySelector("h1"),30),setupTabs(),mockDetectionEvents(),mockBackups(),mockConsole();let e=document.getElementById("planet-container");createPlanet(e,80,650,34,"rgba(200, 100, 50, 0.7)"),createPlanet(e,50,1e3,46,"rgba(100, 200, 150, 0.5)"),createPlanet(e,30,1250,63,"rgba(50, 150, 250, 0.6)"),createPlanet(e,70,400,28,"rgba(200, 150, 200, 0.7)")});const MOCK={detectionEvents:["\uD83C\uDFAE [Gameserver] \uD83D\uDD51 Server is starting up...","\uD83C\uDFAE [Gameserver] ✅ Server process has started!","\uD83C\uDFAE [Gameserver] ⚙️ Setting StartLocalHost changed from False to True","\uD83C\uDFAE [Gameserver] \uD83D\uDD14 Server is ready to connect!","\uD83C\uDFAE [Gameserver] \uD83D\uDCBE World Saved: BackupIndex: 9 UTC Time: 2025-03-30T12:40:08Z","\uD83C\uDFAE [Gameserver] \uD83D\uDCE1 Player BobTheBuilder connecting from 192.168.1.100","\uD83C\uDFAE [Gameserver] \uD83D\uDCE1 Player BobTheBuilder ready","\uD83C\uDFAE [Gameserver] \uD83D\uDCE1 Player SpaceCowboy connecting from 192.168.1.101","\uD83C\uDFAE [Gameserver] \uD83D\uDCE1 Player SpaceCowboy ready","\uD83C\uDFAE [Gameserver] \uD83D\uDC80 Player BobTheBuilder disconnected","\uD83C\uDFAE [Gameserver] ❌ Exception in thread 'main': unity.Exception: random.unity.exeption  caught and handled","\uD83C\uDFAE [Gameserver] \uD83D\uDEA8 Server is stopping...","\uD83C\uDFAE [Gameserver] \uD83D\uDEA8 Server process has stopped!","\uD83C\uDFAE [Gameserver] \uD83D\uDD51 Server is starting up...","\uD83C\uDFAE [Gameserver] ✅ Server process has started!",],backups:["BackupIndex: 8, Created: 29.03.2025 18:59:47","BackupIndex: 7, Created: 28.03.2025 12:30:45","BackupIndex: 6, Created: 27.03.2025 08:15:22","BackupIndex: 5, Created: 26.03.2025 19:20:00","BackupIndex: 4, Created: 25.03.2025 16:45:11","BackupIndex: 3, Created: 24.03.2025 14:30:00","BackupIndex: 2, Created: 23.03.2025 10:15:22","BackupIndex: 1, Created: 22.03.2025 08:45:11"],consoleMessages:["Preview mode active, simulating after-startconsole output","***Stationeers - 0.2.5499.24517***","loaded 48 systems successfully","game manager initialized","World Loaded in 0:0","RocketNet Succesfully hosted with Address: 0.0.0.0 Port: 27016","14:40:06: StartSession. config:","gameName: Preview Server","mapName: Preview Server","No clients connected. Auto pause timer started (10000ms)","Ready"]};function typeText(e,t){let n=e.textContent;e.textContent="";let a=0,r=()=>{a<n.length&&(e.textContent+=n.charAt(a++),setTimeout(r,t))};r()}function typeTextWithCallback(e,t,n,a){e.textContent="";let r=0,o=()=>{r<t.length?(e.textContent+=t.charAt(r++),setTimeout(o,n)):a&&setTimeout(a,50)};o()}function setupTabs(){showTab("console-tab")}function showTab(e){document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-button").forEach(e=>e.classList.remove("active"));let t=document.getElementById(e);t.classList.add("active"),document.querySelector(`.tab-button[onclick*="showTab('${e}')"]`).classList.add("active")}function startServer(){mockToggleServer("start")}function stopServer(){mockToggleServer("stop")}function mockToggleServer(e){let t=document.getElementById("status");t.hidden=!1,typeTextWithCallback(t,{start:"Server started. Tthis is a preview - no actual server is running. But try to set this tool up yourself - it's easy! \uD83D\uDE09",stop:"Server stopped. This is a preview - no actual server was running. Have you tried to set this tool up yourself yet? Come on, you even hit this button! \uD83D\uDE09"}[e],20,()=>{setTimeout(()=>t.hidden=!0,2e4)})}function navigateTo(e){window.location.href=e}function mockDetectionEvents(){let e=document.getElementById("detection-console");function t(t){let n=document.createElement("div");n.className=`detection-event ${getEventClassName(t)}`;let a=document.createElement("span");a.className="event-timestamp",a.textContent=`${new Date().toLocaleTimeString()}: `;let r=document.createElement("span");for(r.textContent=t,n.append(a,r),e.appendChild(n);e.childElementCount>500;)e.firstChild.remove();e.scrollTop=e.scrollHeight;let o=document.getElementById("detection-tab");if(!o.classList.contains("active")){let i=document.querySelector('.tab-button[onclick*="detection-tab"]');i.classList.add("notification"),setTimeout(()=>i.classList.remove("notification"),3e3)}}["Preview mode active, simulating console output",].forEach(e=>{t(e)}),setInterval(()=>{let e=MOCK.detectionEvents[Math.floor(Math.random()*MOCK.detectionEvents.length)];t(e)},5e3)}function getEventClassName(e){return[["Server is ready","event-server-ready"],["Server is starting","event-server-starting"],["Server error","event-server-error"],["Player","connecting","event-player-connecting"],["Player","ready","event-player-ready"],["Player","disconnected","event-player-disconnect"],["World Saved","event-world-saved"],["Exception","event-exception"]].find(([t,n])=>n?e.includes(t)&&e.includes(n):e.includes(t))?.[1]||""}function mockBackups(){let e=document.getElementById("backupList");e.innerHTML="",MOCK.backups.forEach(t=>{let n=document.createElement("li");n.className="backup-item",n.innerHTML=`${t} <button onclick="restoreBackup(${extractIndex(t)})">Restore</button>`,e.appendChild(n)})}function extractIndex(e){return e.match(/Index: (\d+)/)?.[1]||null}function restoreBackup(e){let t=document.getElementById("status"),n=`Restored backup with index ${e}. (This is a preview - no actual restoration occurred)`;t.hidden=!1,typeTextWithCallback(t,n,20,()=>{setTimeout(()=>t.hidden=!0,3e4)})}function mockConsole(){let e=document.getElementById("console");e.innerHTML="";let t=Math.random(),n=["Calibrating quantum flux capacitors...","Initializing player happiness modules...","Checking for monsters under the server...","Brewing coffee for the CPU...","Charging laser sharks...","Teaching AI to say 'please' and 'thank you'...","Polishing pixels to a mirror shine...","Convincing electrons to flow in the right direction...","Rebooting atmospheric systems for the 17th time...","Attempting to locate your body after that last airlock malfunction...","Converting oxygen to errors at alarming efficiency...","Persuading physics engine to acknowledge gravity exists...","Calculating ways your base will catastrophically depressurize...","Optimizing unity garbage collection (good luck with that)...","Aligning planetary rotation with server tick rate...","Patching holes in space-time continuum and your habitat...","Convincing solar panels that 'sun' is not just a theoretical concept...","Negotiating peace treaty between logic circuits and the laws of thermodynamics...","Compressing atmosphere until your CPU begs for mercy...","Measuring distance between you and nearest fatal bug...","Attempting to explain 'pipe networks' to confused server hamsters...","Calculating probability of survival (spoiler: it's low)...","Wrangling rogue Unity instances back into containment...","Sacrificing RAM to the gods of stable framerates...","Convincing electrons to flow in the right direction... nope, the power grid's borked.","Patching hull breaches with duct tape and prayers...","Recalculating O2 levels... wait, why is it all CO2 now?","Spinning up the fabricator... hope it doesn't eat the server this time.","Debugging Unity physics... object launched into orbit, send help.","Warming up the furnace... or just setting the base on fire, 50/50 shot.","Rerouting pipes... because who needs logical fluid dynamics anyway?","Loading terrain... oh look, it's floating 3 meters above the ground again.","Processing ore... into a fine paste of lag and despair.","Stabilizing frame rate... lol, just kidding, welcome to 12 FPS city.","Checking for updates... new bug introduced, feature still broken!","Assembling solar tracker... now it's tracking the admin instead.","Balancing gas mixtures... kaboom imminent, run you fool!"],a=(t,n,a="normal")=>{let r=document.createElement("div");r.textContent=t,r.style.color=n,r.style.fontStyle=a,e.appendChild(r),e.scrollTop=e.scrollHeight};function r(){a("Interface ready.\uD83C\uDFAE Happy gaming! \uD83C\uDFAE","#0f0");let e=0;function t(){e<MOCK.consoleMessages.length?(a(MOCK.consoleMessages[e],"#fff"),e++,setTimeout(t,2e3+3e3*Math.random())):setTimeout(()=>{let e=MOCK.consoleMessages[Math.floor(Math.random()*MOCK.consoleMessages.length)];a(e,"#fff"),setTimeout(t,3e3+5e3*Math.random())},3e3)}setTimeout(t,1500)}typeTextWithCallback(e,"Interface initializing...",30,()=>{let e=Math.floor(Math.random()*n.length);a(n[e],"#0af","italic");let o;do o=Math.floor(Math.random()*n.length);while(o===e);a(n[o],"#0af","italic"),setTimeout(()=>{t<.05?(a("ERROR: Nuclear parts in airflow detected! Initiating repair sequence...","red"),setTimeout(()=>{a("Repair complete. Continuing initialization...","green"),r()},1e3)):r()},1e3)})}function createPlanet(e,t,n,a,r){let o=document.createElement("div");o.classList.add("orbit"),o.style.width=`${2*n}px`,o.style.height=`${2*n}px`,o.style.position="absolute",o.style.left="50%",o.style.top="50%",o.style.transform="translate(-50%, -50%)",o.style.animation=`orbit ${a}s linear infinite ${-(Math.random()*a)}s`;let i=document.createElement("div");i.classList.add("planet"),i.style.width=`${t}px`,i.style.height=`${t}px`,i.style.position="absolute",i.style.left="0%",i.style.top="50%",i.style.backgroundColor=r,i.style.borderRadius="50%",i.style.boxShadow=`0 0 20px ${r}`,o.appendChild(i),e.appendChild(o)}
          EOF

      - name: Modify index.html
        run: |
          # Copy index.html to root
          cp UIMod/index.html .
          # Fix button navigation
          sed -i "s|navigateTo('/config')|navigateTo('/static/config.html')|g" index.html
          # Fix static paths with repo name
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          sed -i "s|/static/|/${REPO_NAME}/static/|g" index.html

      - name: Modify config.html
        run: |
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          sed -i "s|/static/|/${REPO_NAME}/static/|g" ./static/config.html

      - name: Modify apiinfo.html
        run: |
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          sed -i "s|/static/|/${REPO_NAME}/static/|g" ./static/apiinfo.html

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4